<!-- AR.js by @jerome_etienne - github: https://github.com/jeromeetienne/ar.js - info: https://medium.com/arjs/augmented-reality-in-10-lines-of-html-4e193ea9fdbf -->
<!--
<script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
<script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.5.5/aframe/build/aframe-ar.js"></script>
-->
<style>
@font-face {
  font-family: "Bacon";
  src: url('/plasdrip.ttf');
}
</style>
<script src="aframe.min.js"></script>
<script src="aframe-ar.js"></script>
<script src="aframe-extras.loaders.min.js"></script>

<script>
AFRAME.registerComponent('wall', {
  schema: {
    width: {type: 'number', default: 1},
    height: {type: 'number', default: 1}
  },

  /**
  * Initial creation and setting of the mesh.
  */
  init: function () {
    var data = this.data;
    var el = this.el;

    // Create geometry.
    var shape = new THREE.Shape();
    shape.moveTo(-data.width/2, -data.height/2)
    shape.lineTo(data.width/2, -data.height/2)
    shape.lineTo(data.width/2, data.height/2)
    shape.lineTo(-data.width/2, data.height/2)
    this.geometry = new THREE.ShapeGeometry(shape)

    // Create mesh.
    this.mesh = new THREE.Mesh(this.geometry, null);

    // Set mesh on entity.
    el.setObject3D('mesh', this.mesh);
  }
});

var place = 'outside';
var data = {
  'outside': {place: 'outside', left: {text: 'Welcome to the\nChoose Your Own\nScary I.T. Adventure.\nPress on the house\nto enter.'}, back: {image: '#hh', press: {move: 'entry'}}, right: {image: '#solnet'}, floor: {image: '#path'}},
  'entry': {place: 'entry', message: 'You have started\nyour project.', left: {image: '#to-stairs'}, back: {image: '#to-hall'}, right: {image: '#to-living'}, floor: {image: '#floor'}}
};

</script>
<body style='margin : 0px; overflow: hidden;'>
  <a-scene embedded arjs='sourceType: webcam;'>
    <a-assets>
    <!--
    <a-asset-item id="tree" src="Buggy.gltf"></a-asset-item>
    -->
      <img id="img1" src="sb-tight.png">
      <img id="hh" src="images/hh512.png">
      <img id="sm" src="sm.png">
      <img id="m2" src="m2.png">
      <img id="path" src="images/path512.png">
      <img id="solnet" src="images/solnet.png">
      <img id="floor" src="images/floor512.png">
      <img id="to-stairs" src="images/to-stairs512.png">
      <img id="to-hall" src="images/to-hall512.png">
      <img id="to-living" src="images/to-living512.png">
      <canvas id='debug-canvas' />
      <canvas id='message-canvas' />
      <canvas id='left-canvas' />
    </a-assets>
  <!--
  <a-entity gltf-model="#tree" scale='0.01 0.01 0.01' animation-mixer='clip: *'></a-entity>

    <a-plane id="debug-info" position='0 0 -2' material="src: #debug-canvas" rotation='-60 0 0'></a-box>
  -->

    <a-entity id='frame' >
    </a-entity>

    <!--
    <a-marker-camera preset='custom' type='pattern' patternUrl='https://davidplumpton.github.com/artest/sb-fix.patt'></a-marker-camera>
    -->
    <a-marker-camera preset='hiro' class='my-camera'>
    </a-marker-camera>
  </a-scene>

  <script>
    function show(a1, a2, a3, a4, a5, a6) {
      var c = document.getElementById('debug-canvas')
      var ctx = c.getContext('2d')
      ctx.font = '20pt Arial'
      ctx.clearRect(0, 0, c.width, c.height);
      ctx.fillText(a1, 10, 25)
      ctx.fillText(a2, 10, 50)
      ctx.fillText(a3, 10, 75)
      ctx.fillText(a4, 10, 100)
      ctx.fillText(a5, 10, 125)
      ctx.fillText(a6, 10, 150)
    }

    var createTextWall = function(entity, wallName, text) {
      var wallSelector = '#' + wallName + '-canvas'
      var c = document.querySelector(wallSelector)
      var ctx = c.getContext('2d')
      ctx.font = '20pt Bacon'
      ctx.clearRect(0, 0, c.width, c.height);
      var lines = text.split('\n')
      var y = 25;
      for (var i = 0; i < lines.length; i++) {
        ctx.fillText(lines[i], 10, y)
        y += 25
      }
      entity.setAttribute('material', {src: wallSelector})
    }

    var setConfigurableAttributes = function(wall, wallData, name) {
      if (wallData.text) {
        createTextWall(wall, name, wallData.text)
      } else {
        wall.setAttribute('material', {src: wallData.image})
      }
      if (wallData.press) {
        wall.setAttribute('press', wallData.press.move)
      }
    }

    var createLocation = function(frame, description) {
      console.log('Creating location: ' + description.place)
      var left = document.createElement('a-image')
      left.setAttribute('position', {x: -1, y: 0, z: -0.25})
      left.setAttribute('rotation', {x: 0, y: 45, z: 0})
      setConfigurableAttributes(left, description.left, 'left')
      frame.appendChild(left);
      var back = document.createElement('a-image')
      back.setAttribute('position', {x: 0, y: 0, z: -0.5})
      back.setAttribute('rotation', {x: 0, y: 0, z: 0})
      setConfigurableAttributes(back, description.back, 'back')
      frame.appendChild(back);
      var right = document.createElement('a-image')
      right.setAttribute('position', {x: 1, y: 0, z: -0.25})
      right.setAttribute('rotation', {x: 0, y: -45, z: 0})
      setConfigurableAttributes(right, description.right, 'right')
      frame.appendChild(right);
      var floor = document.createElement('a-image')
      floor.setAttribute('position', {x: 0, y: -0.5, z: 0})
      floor.setAttribute('rotation', {x: -90, y: 0, z: 0})
      setConfigurableAttributes(floor, description.floor, 'floor')
//      floor.setAttribute('wall', {})
      frame.appendChild(floor);
    }

    var area = document.getElementsByClassName('a-canvas')[0];
    var handlePress = function(event, x, y) {
      var area = document.getElementsByClassName('a-canvas')[0];
      var offsetX = 0
      var offsetY = 0
      var containerWidth = window.innerWidth
      var containerHeight = window.innerHeight
      var x11 = (((x - offsetX) / containerWidth) * 2) - 1
      var y11 = 1 - (((y - offsetY) / containerHeight) * 2)
      show(x, x11, y, y11, containerWidth, containerHeight)
      var raycaster = new THREE.Raycaster()
      var pointingVector = new THREE.Vector2(x11, y11)
      var scene = document.querySelector('a-scene')
      var scene3 = scene.object3D
      var camera = scene.camera
      raycaster.setFromCamera(pointingVector, camera)
      var found = raycaster.intersectObjects(scene3.children, true)
      if (found.length > 0) {
        var wall = found[0].object.el
        var press = wall.getAttribute('press')
        if (press) {
          var frame = document.getElementById('frame');
          console.log('FRAME ' + frame)
          while(frame.firstChild) {
            console.log('remove')
            frame.removeChild(frame.firstChild)
          }
          createLocation(frame, data[press])
        }
      }
    }

    area.addEventListener('touchstart', function(event) {
      var x = event.touches[0].clientX || event.touches[0].pageX
      var y = event.touches[0].clientY || event.touches[0].pageY
      handlePress(event, x, y)
      event.preventDefault()
    })
    area.addEventListener('mousedown', function(event) {
      var x = event.clientX || event.pageX
      var y = event.clientY || event.pageY
      handlePress(event, x, y)
    })

  </script>
  <script>
    var scene = document.querySelector('a-scene')
    var scene3 = scene.object3D
    var frame = document.querySelector('#frame');
    createLocation(frame, data['outside'])
  </script>
</body>
